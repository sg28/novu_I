'use strict';

var crypto = require('crypto');
var jsonSchemaFaker = require('json-schema-faker');
var liquidjs = require('liquidjs');
var pe = require('ora');
var crossFetch = require('cross-fetch');
var S = require('chalk');
var shared = require('@novu/shared');
var fe = require('sanitize-html');
var Ve = require('ajv');
var Ye = require('ajv-formats');
var zodToJsonSchema = require('zod-to-json-schema');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

var pe__default = /*#__PURE__*/_interopDefault(pe);
var S__default = /*#__PURE__*/_interopDefault(S);
var fe__default = /*#__PURE__*/_interopDefault(fe);
var Ve__default = /*#__PURE__*/_interopDefault(Ve);
var Ye__default = /*#__PURE__*/_interopDefault(Ye);

var D=(r=>(r.TRIGGER="trigger",r.EXECUTE="execute",r.PREVIEW="preview",r))(D||{}),Y=(r=>(r.DISCOVER="discover",r.HEALTH_CHECK="health-check",r.CODE="code",r))(Y||{});var h=(l=>(l.WORKFLOW_NOT_FOUND_ERROR="WorkflowNotFoundError",l.WORKFLOW_ALREADY_EXISTS_ERROR="WorkflowAlreadyExistsError",l.WORKFLOW_EXECUTION_FAILED_ERROR="WorkflowExecutionFailedError",l.EXECUTION_STATE_OUTPUT_INVALID_ERROR="ExecutionStateOutputInvalidError",l.EXECUTION_STATE_RESULT_INVALID_ERROR="ExecutionStateResultInvalidError",l.EXECUTION_PROVIDER_OUTPUT_INVALID_ERROR="ExecutionProviderOutputInvalidError",l.PROVIDER_NOT_FOUND_ERROR="ProviderNotFoundError",l.PROVIDER_EXECUTION_FAILED_ERROR="ProviderExecutionFailedError",l.STEP_NOT_FOUND_ERROR="StepNotFoundError",l.STEP_ALREADY_EXISTS_ERROR="StepAlreadyExistsError",l.STEP_EXECUTION_FAILED_ERROR="StepExecutionFailedError",l.EXECUTION_STATE_CORRUPT_ERROR="ExecutionStateCorruptError",l.EXECUTION_EVENT_PAYLOAD_INVALID_ERROR="ExecutionEventPayloadInvalidError",l.EXECUTION_EVENT_CONTROL_INVALID_ERROR="ExecutionEventControlInvalidError",l.EXECUTION_STATE_CONTROL_INVALID_ERROR="ExecutionStateControlInvalidError",l.STEP_CONTROL_COMPILATION_FAILED_ERROR="StepControlCompilationFailedError",l.METHOD_NOT_ALLOWED_ERROR="MethodNotAllowedError",l.INVALID_ACTION_ERROR="InvalidActionError",l.MISSING_SECRET_KEY_ERROR="MissingSecretKeyError",l.SIGNATURE_MISMATCH_ERROR="SignatureMismatchError",l.SIGNATURE_NOT_FOUND_ERROR="SignatureNotFoundError",l.SIGNATURE_INVALID_ERROR="SignatureInvalidError",l.SIGNATURE_EXPIRED_ERROR="SignatureExpiredError",l.SIGNING_KEY_NOT_FOUND_ERROR="SigningKeyNotFoundError",l.BRIDGE_ERROR="BridgeError",l.SIGNATURE_VERSION_INVALID_ERROR="SignatureVersionInvalidError",l.WORKFLOW_PAYLOAD_INVALID_ERROR="WorkflowPayloadInvalidError",l))(h||{});var F=(r=>(r.POST="POST",r.GET="GET",r.OPTIONS="OPTIONS",r))(F||{});var _e=(i=>(i.EMAIL="email",i.SMS="sms",i.PUSH="push",i.CHAT="chat",i.IN_APP="in_app",i))(_e||{});var Te="2.1.1";var x=Te,L="2024-06-26";var A=class extends Error{data},b=class extends A{statusCode=404},E=class extends A{statusCode=400},N=class extends A{statusCode=401},g=class extends A{statusCode=500},C=class extends A{statusCode=409};var W=class extends E{code="ExecutionStateCorruptError";constructor(e,t){super(`Workflow with id: \`${e}\` has a corrupt state. Step with id: \`${t}\` does not exist. Please provide the missing state.`),this.data={workflowId:e,stepId:t};}},U=class extends E{code="ExecutionEventPayloadInvalidError";constructor(e,t){super(`Workflow with id: \`${e}\` has invalid \`payload\`. Please provide the correct event payload.`),this.data=t;}},$=class extends E{code="ExecutionEventControlInvalidError";constructor(e,t){super(`Workflow with id: \`${e}\` has invalid \`controls\`. Please provide the correct event controls.`),this.data=t;}},G=class extends E{code="ExecutionStateControlInvalidError";constructor(e,t,r){super(`Workflow with id: \`${e}\` has an invalid state. Step with id: \`${t}\` has invalid \`controls\`. Please provide the correct step controls.`),this.data=r;}},j=class extends E{code="ExecutionStateOutputInvalidError";constructor(e,t,r){super(`Workflow with id: \`${e}\` has an invalid state. Step with id: \`${t}\` has invalid output. Please provide the correct step output.`),this.data=r;}},K=class extends E{code="ExecutionStateResultInvalidError";constructor(e,t,r){super(`Workflow with id: \`${e}\` has an invalid state. Step with id: \`${t}\` has invalid result. Please provide the correct step result.`),this.data=r;}},q=class extends E{code="StepControlCompilationFailedError";constructor(e,t,r){super(`Workflow with id: \`${e}\` has invalid controls syntax in step with id: \`${t}\`. Please correct step control syntax.`),this.data=r;}},B=class extends E{code="ExecutionProviderOutputInvalidError";constructor(e,t,r,s){super(`Workflow with id: \`${e}\` has an invalid state. Step with id: \`${t}\` and provider with id: \`${r}\` has invalid output. Please provide the correct provider output.`),this.data=s;}};var X=class extends A{statusCode;data;code;constructor(e,t,r){super(),this.data={message:r},this.statusCode=e,this.code=t;}};var Ae=()=>typeof Response<"u"?Response:crossFetch.Response;var p={info:o=>S__default.default.blue(o),warning:o=>S__default.default.yellow(o),error:o=>S__default.default.red(o),success:o=>S__default.default.green(o),underline:o=>S__default.default.underline(o),bold:o=>S__default.default.bold(o)},_={SUCCESS:p.success("\u2714"),ERROR:p.error("\u2717"),WARNING:p.warning("\u26A0"),INFO:p.info("\u2139"),ARROW:p.bold("\u2192"),MOCK:p.info("\u25CB"),HYDRATED:p.bold(p.info("\u2192")),STEP:p.info("\u03C3"),ACTION:p.info("\u03B1"),DURATION:p.info("\u0394"),PROVIDER:p.info("\u2699"),OUTPUT:p.info("\u21E2"),INPUT:p.info("\u21E0"),WORKFLOW:p.info("\u03C9"),STATE:p.info("\u03C3"),EXECUTE:p.info("\u03B5"),PREVIEW:p.info("\u03C1")};var Oe=o=>Object.values(o).map(e=>`\`${e}\``).join(", "),J=o=>o.replaceAll(/(\w)(\w*)/g,(e,t,r)=>t.toUpperCase()+r.toLowerCase()).replaceAll(/[\s-]+/g,"");var me=(o,e="https://api.novu.co")=>{let t=process.env.NOVU_API_URL||e;return {post:async(r,s)=>{let i=await fetch(`${t}/v1${r}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`ApiKey ${o}`},body:JSON.stringify(s)}),n=await i.json();if(i.ok)return n;throw shared.checkIsResponseError(n)?new X(n.statusCode,n.error,n.message):new y("Error processing API request to Novu Cloud from Bridge application.")},delete:async r=>(await fetch(`${t}/v1${r}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`ApiKey ${o}`}})).json()}};var Ue={allowedTags:fe__default.default.defaults.allowedTags.concat(["style","img","html","head","body","link","meta","title"]),allowedAttributes:!1,allowVulnerableTags:!0,parseStyleAttributes:!1,parser:{lowerCaseAttributeNames:!0}},Ie=o=>{if(!o)return o;let e=/^<!DOCTYPE .*?>/,t=o.match(e),r=fe__default.default(o,Ue);return t?t[0]+r:r},z=o=>Object.keys(o).reduce((e,t)=>{let r=o[t];return typeof r=="string"?e[t]=Ie(r):Array.isArray(r)?e[t]=r.map(s=>typeof s=="string"?Ie(s):typeof s=="object"?z(s):s):typeof r=="object"&&r!==null?e[t]=z(r):e[t]=r,e},{});var Z=class extends A{code="MethodNotAllowedError";statusCode=405;message=`Method not allowed. Please use one of ${Oe(F)}`},k=class extends E{code="InvalidActionError";constructor(e,t){super(`Invalid query string: \`action\`=\`${e}\`. Please use one of ${Oe(t)}`);}};var y=class extends g{code="BridgeError";message="Something went wrong. Please try again later."};var M=class extends C{constructor(e,t){super(`${J(e)} with id: \`${t}\` already exists. Please use a different id.`);}},v=class extends b{constructor(e,t){super(`${J(e)} with id: \`${t}\` does not exist. Please provide a valid id.`);}},P=class extends g{constructor(e,t){super(`Failed to execute ${J(e)} with id: \`${t}\`. Please try again later.`);}};var Q=class extends v{code="ProviderNotFoundError";constructor(e){super("provider",e);}},H=class extends P{code="ProviderExecutionFailedError";constructor(e){super("workflow",e);}};var ee=class extends N{code="SignatureMismatchError";constructor(){super("Signature does not match the expected signature. Please ensure the signature provided in the `novu-signature` header is correct and try again.");}},te=class extends N{code="SignatureNotFoundError";constructor(){super("Signature not found. Please provide a signature in the `novu-signature` header");}},re=class extends N{code="SignatureInvalidError";constructor(){super("Signature is invalid. Please provide a valid signature in the `novu-signature` header");}},oe=class extends N{code="SignatureExpiredError";constructor(){super(`Signature expired. Please provide a signature with a timestamp no older than ${5} minutes in the \`novu-signature\` header`);}},se=class extends N{code="SigningKeyNotFoundError";constructor(){super("Signature key not found. Please provide a valid key in the Client constructor `config.secretKey`");}};var ie=class extends v{code="StepNotFoundError";constructor(e){super("step",e);}};var V=class extends v{code="WorkflowNotFoundError";constructor(e){super("workflow",e);}},ne=class extends M{code="WorkflowAlreadyExistsError";constructor(e){super("workflow",e);}};var Ne=o=>typeof structuredClone=="function"?structuredClone(o):JSON.parse(JSON.stringify(o));var ae=class{ajv;compiledSchemas;constructor(){this.ajv=new Ve__default.default({useDefaults:!0,removeAdditional:"failing"}),Ye__default.default(this.ajv),this.compiledSchemas=new Map;}canHandle(e){return typeof e=="boolean"?!1:e.type==="object"||!!e.anyOf||!!e.allOf||!!e.oneOf}async validate(e,t){let r=this.compiledSchemas.get(t);r||(r=this.ajv.compile(t),this.compiledSchemas.set(t,r));let s=Ne(e);return r(s)?{success:!0,data:s}:{success:!1,errors:r.errors.map(n=>({path:n.instancePath,message:n.message}))}}transformToJsonSchema(e){return e}};var ce=class{canHandle(e){return e.safeParseAsync!==void 0}async validate(e,t){let r=t.safeParse(e);return r.success?{success:!0,data:r.data}:{success:!1,errors:r.error.errors.map(s=>({path:`/${s.path.join("/")}`,message:s.message}))}}transformToJsonSchema(e){try{return zodToJsonSchema.zodToJsonSchema(e)}catch(t){throw t?.message?.includes("Cannot find module")&&console.error("Tried to use a zod schema in @novu/framework without `zod-to-json-schema` installed. Please install it by running `npm install zod-to-json-schema`."),t}}};var de=new ce,le=new ae,ve=async(o,e)=>{if(de.canHandle(o))return de.validate(e,o);if(le.canHandle(o))return le.validate(e,o);throw new Error("Invalid schema")},ge=o=>{if(de.canHandle(o))return de.transformToJsonSchema(o);if(le.canHandle(o))return le.transformToJsonSchema(o);throw new Error("Invalid schema")};jsonSchemaFaker.JSONSchemaFaker.random.shuffle=function(){return ["[placeholder]"]};jsonSchemaFaker.JSONSchemaFaker.option({useDefaultValue:!0,alwaysFakeOptionals:!0});function be(){return ["development",void 0].includes(process.env.NODE_ENV)}var ue=class{discoveredWorkflows=[];templateEngine=new liquidjs.Liquid;secretKey;version=x;strictAuthentication;constructor(e){let t=this.buildOptions(e);this.secretKey=t.secretKey,this.strictAuthentication=t.strictAuthentication;}buildOptions(e){let t={secretKey:void 0,strictAuthentication:!be()};return t.secretKey=e?.secretKey||process.env.NOVU_SECRET_KEY||process.env.NOVU_API_KEY,e?.strictAuthentication!==void 0?t.strictAuthentication=e.strictAuthentication:process.env.NOVU_STRICT_AUTHENTICATION_ENABLED!==void 0&&(t.strictAuthentication=process.env.NOVU_STRICT_AUTHENTICATION_ENABLED==="true"),t}addWorkflows(e){for(let t of e){if(this.discoveredWorkflows.some(r=>r.workflowId===t.definition.workflowId))throw new ne(t.definition.workflowId);this.discoveredWorkflows.push(t.definition);}}healthCheck(){let e=this.discoveredWorkflows.length,t=this.discoveredWorkflows.reduce((r,s)=>r+s.steps.length,0);return {status:"ok",sdkVersion:x,frameworkVersion:L,discovered:{workflows:e,steps:t}}}getWorkflow(e){let t=this.discoveredWorkflows.find(r=>r.workflowId===e);if(t)return t;throw new V(e)}getStep(e,t){let s=this.getWorkflow(e).steps.find(i=>i.stepId===t);if(s)return s;throw new ie(t)}getRegisteredWorkflows(){return this.discoveredWorkflows}discover(){return {workflows:this.getRegisteredWorkflows()}}mock(e){return jsonSchemaFaker.JSONSchemaFaker.generate(ge(e))}async validate(e,t,r,s,i,n,d){let a=await ve(t,e);if(a.success)return a.data;switch(r){case"event":this.throwInvalidEvent(s,i,a.errors);case"step":this.throwInvalidStep(n,s,i,a.errors);case"provider":this.throwInvalidProvider(n,d,s,i,a.errors);default:throw new Error(`Invalid component: '${r}'`)}}throwInvalidProvider(e,t,r,s,i){if(!e)throw new Error("stepId is required");if(!t)throw new Error("providerId is required");switch(r){case"output":throw new B(s,e,t,i);default:throw new Error(`Invalid payload type: '${r}'`)}}throwInvalidStep(e,t,r,s){if(!e)throw new Error("stepId is required");switch(t){case"output":throw new j(r,e,s);case"result":throw new K(r,e,s);case"controls":throw new G(r,e,s);default:throw new Error(`Invalid payload type: '${t}'`)}}throwInvalidEvent(e,t,r){switch(e){case"controls":throw new $(t,r);case"payload":throw new U(t,r);default:throw new Error(`Invalid payload type: '${e}'`)}}executeStepFactory(e,t){return async(r,s,i)=>{let n=this.getStep(e.workflowId,r),d=await this.createStepControls(n,e),a=e.action==="preview";if(!a&&await this.shouldSkip(i?.skip,d))return r===e.stepId&&t({options:{skip:!0},outputs:{},providers:{}}),{};let O=this.previewStep.bind(this),c=this.executeStep.bind(this),R=await(a?O:c)(e,{...n,providers:n.providers.map(I=>{let T=i?.providers?.[I.type];if(!T)throw new Q(I.type);return {...I,resolve:T}}),resolve:s});return Object.values(_e).includes(n.type)&&(R={...R,outputs:z(R.outputs)}),r===e.stepId&&t({...R,options:{skip:!1}}),R.outputs}}async shouldSkip(e,t){return e?e(t):!1}async executeWorkflow(e){let s=`${e.action==="execute"?"Executed":e.action==="preview"?"Previewed":"Invalid action"} workflowId:`;console.log(`
${p.bold(p.underline(s))} '${e.workflowId}'`);let i=this.getWorkflow(e.workflowId),n=process.hrtime(),d={outputs:{},providers:{},options:{skip:!1}},a,O=new Promise(f=>{a=f;}),c=f=>{a(),d=f;},u;try{if(e.action==="execute"&&!e.payload&&!e.data)throw new U(e.workflowId,{message:"Event `payload` is required"});let f=await this.createExecutionPayload(e,i),w={...e,payload:f};await Promise.race([O,i.execute({payload:f,environment:{},input:{},controls:{},subscriber:e.subscriber,step:{email:this.executeStepFactory(w,c),sms:this.executeStepFactory(w,c),inApp:this.executeStepFactory(w,c),digest:this.executeStepFactory(w,c),delay:this.executeStepFactory(w,c),push:this.executeStepFactory(w,c),chat:this.executeStepFactory(w,c),custom:this.executeStepFactory(w,c)}})]);}catch(f){u=f;}let R=process.hrtime(n),I=R[0],T=R[1],m=I*1e3+T/1e6,Se=u?_.ERROR:_.SUCCESS,ye=e.action==="execute"?"Executed":e.action==="preview"?"Previewed":"Invalid action";if(console.log(`${Se} ${ye} workflowId: \`${e.workflowId}\``),this.prettyPrintExecute(e,m,u),u)throw u;return {outputs:d.outputs,providers:d.providers,options:d.options,metadata:{status:"success",error:!1,duration:m}}}async createExecutionPayload(e,t){let r=e.payload||e.data;if(e.action==="preview"){let i=this.mock(t.payload.schema);r=Object.assign(i,r);}return await this.validate(r,t.payload.unknownSchema,"event","payload",e.workflowId)}prettyPrintExecute(e,t,r){let s=r?_.ERROR:_.SUCCESS,i=e.action==="execute"?"Executed":e.action==="preview"?"Previewed":"Invalid action",n=r?"Failed to execute":i,d=r?p.error:p.success,a=`${s} ${n} workflowId: '${e.workflowId}`;console.log(`
  ${p.bold(d(a))}'`),console.log(`  \u251C ${_.STEP} stepId: '${e.stepId}'`),console.log(`  \u251C ${_.ACTION} action: '${e.action}'`),console.log(`  \u2514 ${_.DURATION} duration: '${t.toFixed(2)}ms'
`);}async executeProviders(e,t,r){return t.providers.reduce(async(s,i)=>{let n=await s,d=this.previewProvider.bind(this),a=this.executeProvider.bind(this),c=await(e.action==="preview"?d:a)(e,t,i,r);return {...n,[i.type]:c}},Promise.resolve({}))}previewProvider(e,t,r,s){return console.log(`  ${_.MOCK} Mocked provider: \`${r.type}\``),this.mock(r.outputs.schema)}async executeProvider(e,t,r,s){let i=pe__default.default({indent:2}).start(`Executing provider: \`${r.type}\``);try{if(e.stepId===t.stepId){let n=await this.createStepControls(t,e),d=await r.resolve({controls:n,outputs:s}),a=await this.validate(d,r.outputs.unknownSchema,"step","output",e.workflowId,t.stepId,r.type);return i.succeed(`Executed provider: \`${r.type}\``),{...a,_passthrough:d._passthrough}}else return i.stopAndPersist({symbol:_.HYDRATED,text:`Hydrated provider: \`${r.type}\``}),{}}catch(n){throw i.stopAndPersist({symbol:_.ERROR,text:`Failed to execute provider: \`${r.type}\``}),new H(`Failed to execute provider: '${r.type}'.
${n.message}`)}}async executeStep(e,t){if(e.stepId===t.stepId){let r=pe__default.default({indent:1}).start(`Executing stepId: \`${t.stepId}\``);try{let s=await this.createStepControls(t,e),i=await this.compileControls(s,e),n=await t.resolve(i),d=await this.validate(n,t.outputs.unknownSchema,"step","output",e.workflowId,t.stepId),a=await this.executeProviders(e,t,d);return r.succeed(`Executed stepId: \`${t.stepId}\``),{outputs:d,providers:a}}catch(s){throw r.stopAndPersist({prefixText:"",symbol:_.ERROR,text:`Failed to execute stepId: \`${t.stepId}\``}),s}}else {let r=pe__default.default({indent:1}).start(`Hydrating stepId: \`${t.stepId}\``);try{let s=e.state.find(i=>i.stepId===t.stepId);if(s){let i=await this.validate(s.outputs,t.results.unknownSchema,"step","result",e.workflowId,t.stepId);return r.stopAndPersist({symbol:_.HYDRATED,text:`Hydrated stepId: \`${t.stepId}\``}),{outputs:i,providers:await this.executeProviders(e,t,i)}}else throw new W(e.workflowId,t.stepId)}catch(s){throw r.stopAndPersist({symbol:_.ERROR,text:`Failed to hydrate stepId: \`${t.stepId}\``}),s}}}async compileControls(e,t){try{let r=this.templateEngine.parse(JSON.stringify(e)),s=await this.templateEngine.render(r,{payload:t.payload||t.data,subscriber:t.subscriber,...t.payload||t.data});return JSON.parse(s)}catch(r){throw new q(t.workflowId,t.stepId,r)}}async createStepControls(e,t){let r=t.controls||t.inputs;return await this.validate(r,e.controls.unknownSchema,"step","controls",t.workflowId,e.stepId)}async previewStep(e,t){let r=pe__default.default({indent:1}).start(`Previewing stepId: \`${t.stepId}\``);try{if(e.stepId===t.stepId){let s=await this.createStepControls(t,e),i=await this.compileControls(s,e),n=await t.resolve(i),d=await this.validate(n,t.outputs.unknownSchema,"step","output",e.workflowId,t.stepId);return r.stopAndPersist({symbol:_.MOCK,text:`Mocked stepId: \`${t.stepId}\``}),{outputs:d,providers:await this.executeProviders(e,t,d)}}else {let s=this.mock(t.results.schema);return r.stopAndPersist({symbol:_.MOCK,text:`Mocked stepId: \`${t.stepId}\``}),{outputs:s,providers:await this.executeProviders(e,t,s)}}}catch(s){throw r.stopAndPersist({symbol:_.ERROR,text:`Failed to preview stepId: \`${t.stepId}\``}),s}}getStepCode(e,t){return {code:this.getStep(e,t).resolve.toString()}}getWorkflowCode(e){return {code:this.getWorkflow(e).execute.toString()}}getCode(e,t){let r;if(e)t?r=this.getStepCode(e,t):r=this.getWorkflowCode(e);else throw new V(e);return r}};var Re=class{frameworkName;handler;client;hmacEnabled;http;constructor(e){this.handler=e.handler,this.client=e.client?e.client:new ue,this.client.addWorkflows(e.workflows),this.http=me(this.client.secretKey),this.frameworkName=e.frameworkName,this.hmacEnabled=this.client.strictAuthentication;}createHandler(){return async(...e)=>{let t=await this.handler(...e),r=await this.handleAction({actions:t});return t.transformResponse(r)}}getStaticHeaders(){let e=`novu-framework:v${this.client.version}`;return {"content-type":"application/json","access-control-allow-origin":"*","access-control-allow-methods":"GET, POST","access-control-allow-headers":"*","access-control-max-age":"604800","novu-framework-version":L,"novu-framework-sdk":x,"novu-framework-server":this.frameworkName,"user-agent":e}}createResponse(e,t){return {status:e,body:JSON.stringify(t),headers:{...this.getStaticHeaders()}}}createError(e){return {status:e.statusCode,body:JSON.stringify({message:e.message,data:e.data,code:e.code}),headers:this.getStaticHeaders()}}async handleAction({actions:e}){let t=await e.url(),r=await e.method(),s=t.searchParams.get("action")||"",i=t.searchParams.get("workflowId")||"",n=t.searchParams.get("stepId")||"",d=await e.headers("novu-signature")||await e.headers("x-novu-signature")||"",a={};try{r==="POST"&&(a=await e.body());}catch{}try{s!=="health-check"&&this.validateHmac(a,d);let O=this.getPostActionMap(a,i,n,s),c=this.getGetActionMap(i,n);if(r==="POST")return await this.handlePostAction(s,O);if(r==="GET")return await this.handleGetAction(s,c);if(r==="OPTIONS")return this.createResponse(200,{})}catch(O){return this.handleError(O)}return this.createError(new Z(r))}getPostActionMap(e,t,r,s){return {trigger:this.triggerAction({workflowId:t,...e}),execute:async()=>{let i=await this.client.executeWorkflow({...e,workflowId:t,stepId:r,action:s});return this.createResponse(200,i)},preview:async()=>{let i=await this.client.executeWorkflow({...e,workflowId:t,stepId:r,action:s});return this.createResponse(200,i)}}}triggerAction(e){return async()=>{let t={name:e.workflowId,to:e.to,payload:e?.payload||{},transactionId:e.transactionId,overrides:e.overrides||{},...e.actor&&{actor:e.actor},...e.bridgeUrl&&{bridgeUrl:e.bridgeUrl},...e.controls&&{controls:e.controls}},r=await this.http.post("/events/trigger",t);return this.createResponse(200,r)}}getGetActionMap(e,t){return {discover:async()=>{let r=await this.client.discover();return this.createResponse(200,r)},"health-check":async()=>{let r=await this.client.healthCheck();return this.createResponse(200,r)},code:async()=>{let r=await this.client.getCode(e,t);return this.createResponse(200,r)}}}async handlePostAction(e,t){if(Object.values(D).includes(e)){let r=t[e];return r()}else throw new k(e,D)}async handleGetAction(e,t){if(Object.values(Y).includes(e)){let r=t[e];return r()}else throw new k(e,Y)}isBridgeError(e){return Object.values(h).includes(e?.code)}isPlatformError(e){return e?.statusCode>=400&&e?.statusCode<500}handleError(e){return this.isBridgeError(e)?(e.statusCode===500&&console.error(e),this.createError(e)):this.isPlatformError(e)?this.createError(e):(console.error(e),this.createError(new y))}validateHmac(e,t){if(!this.hmacEnabled)return;if(!t)throw new te;if(!this.client.secretKey)throw new se;let[r,s]=t.split(",");if(!r||!s)throw new re;let[i,n]=r.split("="),[d,a]=s.split("=");if(Number(i)<Date.now()-1500)throw new oe;if(!(this.hashHmac(this.client.secretKey,`${n}.${JSON.stringify(e)}`)===a))throw new ee}hashHmac(e,t){return crypto.createHmac("sha256",e).update(t).digest("hex")}};var $e="next",Zr=o=>{let t=new Re({frameworkName:$e,...o,handler:(i,n,d)=>{let a=n,O=c=>{let u=typeof a.headers.get=="function"?a.headers.get(c):a.headers[c];return Array.isArray(u)?u[0]:u};return {body:()=>typeof a.json=="function"?a.json():a.body,headers:O,method:()=>i||a.method||"",queryString:(c,u)=>{let R=a.query?.[c]||u.searchParams.get(c);return Array.isArray(R)?R[0]:R},url:()=>{let c;try{c=new URL(a.url);}catch{}if(c){let T=O("host");if(T){let m=new URL(T.includes("://")?T:`${c.protocol}//${T}`);c.protocol=m.protocol,c.host=m.host,c.port=m.port,c.username=m.username,c.password=m.password;}return c}let u="https",R=O("host")||"";try{process.env.NODE_ENV==="development"&&(u="http");}catch{}return new URL(a.url,`${u}://${R}`)},transformResponse:({body:c,headers:u,status:R})=>{if(typeof d?.setHeader=="function"&&Object.entries(u).forEach(([T,m])=>{d.setHeader(T,m);}),typeof d?.status=="function"&&typeof d?.send=="function"){d.status(R).send(c);return}let I=Ae();return new I(c,{status:R,headers:u})}}}}).createHandler(),r=t.bind(null,void 0);return Object.defineProperties(r,{GET:{value:t.bind(null,"GET")},POST:{value:t.bind(null,"POST")},OPTIONS:{value:t.bind(null,"OPTIONS")}})};

exports.frameworkName = $e;
exports.serve = Zr;
